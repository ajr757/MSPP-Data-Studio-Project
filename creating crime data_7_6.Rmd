---
title: "Data Project"
author: "Ally Rakus"
date: "6/22/2020"
output: github_document
---

Calling the packages 
```{r message=FALSE}
library(dplyr) # manipulate dataframes
library(readr) # read/write3 dataframes
library(ggplot2) # making plots
```

Import the crime data and reformat the date into the R date type (Y-M-D)
```{r}
library(readr)
library(fs)

bmore_crime_data_6_22 <- read_csv(path("bmore crime data_6_22.csv"),
 col_types = cols(
   CrimeDate = col_date(format = "%m/%d/%Y")
 )
)

bmore_crime_data_6_22

```

Filtering for incidents that occurred in years that match the census data (2014-2018)
```{r}
bmore_crime_data_2014_2018 <- filter(bmore_crime_data_6_22, between(CrimeDate, as.Date("2014-01-01"),as.Date("2018-12-31")))

bmore_crime_data_2014_2018
```

Removing duplicate rows 
```{r}
library(janitor)
bmore_crime_data_2014_2018 %>% get_dupes

```

Filtering for incidents considered to be property crime 
```{r}
bmore_property_crime_2014_2018 <- filter(bmore_crime_data_2014_2018, Description %in% c("BURGLARY", "LARCENY", "LARCENY FROM AUTO", "AUTO THEFT", "ARSON", "ROBBERY - STREET", "ROBBERY - CARJACKING", "ROBBERY - COMMERCIAL", "ROBBERY - RESIDENCE")
)

bmore_property_crime_2014_2018
```

Assigning a unique ID to each obs
```{r}
bmore_property_crime_2014_2018 %>% mutate(id = row_number())
```

Getting rid of incidents without coordinates/lat-long data and keeping variables of interest
```{r}

bmore_property_crime_2014_2018 %>% 
  filter(!Longitude == "NA") %>% 
  filter(!Latitude == "NA") %>% 
  select(Latitude, Longitude, District, Description, CrimeTime, CrimeDate) 

bmore_property_crime_dates

```

Transforming the lat/lon data into spatial points 

**na.fail = false dropped datapoints with missing values
```{r}
library(sf)

bmore_property_crime_2014_2018_sf <- bmore_property_crime_2014_2018 %>% 
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, na.fail = FALSE) %>% 
  st_transform(6487) # https://epsg.io/6487
```

Calling Census population data - helpful for creating crime rate for the census tracts
```{r}
library(tidycensus)

census_api_key("d432da892f8a6ce576e962e7170b27cf7ef13f8d", overwrite = TRUE, install = TRUE) 

bmore_tracts_pop <- get_acs(
  geography = "tract", 
  state = "MD",
  county = c("510"),
  variables = c("pop_num" = "B01001_001"),
  survey = "acs5",
  output = "wide",
  year = 2018,
  geometry = TRUE
) %>% 
  st_transform(6487)
```

```{r}

bmore_crime_tract <- bmore_tracts_pop %>% 
  st_join(bmore_property_crime_2014_2018_sf, join = st_intersects) %>%
  mutate(year = year(CrimeDate)) %>%
  group_by(GEOID, year) %>%
  summarise(
    pop_numE = max(pop_numE),
    pop_numM = max(pop_numM),
    n_crimes = n()
  ) %>% 
  ungroup()
  
 bmore_crime_tract 
```

Creating the crime rate per census tract variable 
```{r}
bmore_crime_rate_2018 <- bmore_crime_tract %>% 
  filter(year == "2018") %>% 
  mutate(
    crime_rate = (n_crimes / na_if(pop_numE,0))*1000,
    crime_rate_moe = moe_prop(n_crimes, na_if(pop_numE,0), n_crimes, pop_numM)
  )

bmore_crime_rate_2018
```

Creating crime map 2 - crime rate per census tract 
```{r}
library(leaflet)
library(htmlwidgets)

#color palette for crime quantity
crime_rate_pal <- colorBin(
  palette = viridisLite::viridis(5), 
  domain = bmore_crime_rate_2018$crime_rate, 
  n = 4
)

#creating the map
crime_map_2018 <- bmore_crime_rate_2018 %>% 
  st_transform(4326) %>% 
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  
#plotting the black population layer 
  addPolygons(
    fillColor = ~crime_rate_pal(crime_rate),
    fillOpacity = 0.7,
    color = "white",
    weight = 0.5,
    group = "Property Crime Rate"
  ) %>% 
  
  addLayersControl(
    overlayGroups = c("Property Crime Rate"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  showGroup(c("Property Crime Rate")) %>% 

#creating the legend for black population
  addLegend(
    position = "topleft", 
    pal = crime_rate_pal, 
    values = ~crime_rate, 
    title = "2018 Property Crime Rate per 1000 residents<br>by Census Tract"
  )

crime_map_2018

htmlwidgets::saveWidget(crime_map_2018, "census_map_2018.html", selfcontained = TRUE)
```

Analysis: 
1. merge the census and crime data by geoid
2. correlation coefficient 
```{r}
st_join(bmore_crime_rate_2018, bmore_unemployment_rate, by = "GEOID")
```








