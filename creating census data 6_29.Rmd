---
title: "Census Data"
author: "Ally Rakus"
date: "6/25/2020"
output: github_document
---

Creating my Census API Key 
```{r}
library(tidyverse)
library(tidycensus)

census_api_key("d432da892f8a6ce576e962e7170b27cf7ef13f8d", overwrite = TRUE, install = TRUE) 

```

Looking at the Census Variables
```{r}
v18 <- load_variables(2018, "acs5", cache = TRUE)
v18
```

Calling the variables I need: income, poverty rate, educational attainment, unemployment, race/ethnicity

1. Calling for income and poverty rate 
```{r}
bmore_census_inc_pov <- get_acs(
  geography = "tract", 
  state = "MD",
  county = c("510"),
  variables = c(
    "hh_inc_med" = "B19013_001", # median household inc
    "pov_pct" = "C17002_001" # poverty rate
  ), 
  survey = "acs5",
  output = "wide",
  geometry = FALSE)
bmore_census_inc_pov
```
2. Calling for the unemployment table then manipulating that data 
```{r}
bmore_census_unemploy <- get_acs(
  geography = "tract", 
  state = "MD",
  county = c("510"),
  table = "B23001",
  survey = "acs5",
  output = "wide",
  geometry = FALSE)
bmore_census_unemploy
```
Creating variables: labor force, unemployed, unemployment rate
```{r}

# These operations with rowwise() can be quite confusing, but unfortunately it's
# necessary given how the moe_sum() function works. The regular expression is
# also a bit confusing, but is also a bit easier to read than if you had to
# write out every variable name in full. What the matches() is doing is
# selecting all the columns whose names match this regular expression. And the
# regular expression (regex) is a way to concisely write a pattern that it
# should match. My first attempt at this wasn't actually working as intended. I
# did some testing and this works now. You can see how i tested it out here
# https://regex101.com/r/KGti8P/1 I copied the names from the dataset and then
# wrote the regex and made sure it was selecting everything we wanted (and
# nothing extra!)

bmore_census_unemployment <- bmore_census_unemploy %>% 
  rowwise() %>% 
  mutate(
    
    laborforce_est = sum(
      c_across(matches("B23001_0{0,2}(6|13|20|27|34|41|48|55|62|69|74|79|84|92|99|106|113|120|127|134|141|148|155|160|165|170)E"))
    ),
    
    laborforce_moe = moe_sum(
      moe = c_across(matches("B23001_0{0,2}(6|13|20|27|34|41|48|55|62|69|74|79|84|92|99|106|113|120|127|134|141|148|155|160|165|170)M")),
      estimate = laborforce_est
    ),
    
    pop_unemployed_est = sum(
      c_across(c(matches("B23001_0{0,2}(8|15|22|29|36|43|50|57|64|71|76|81|86|94|101|108|115|122|129|136|143|150|157|162|167|172)E")))
    ),
    
    pop_unemployed_moe = moe_sum(
      moe = c_across(c(matches("B23001_0{0,2}(8|15|22|29|36|43|50|57|64|71|76|81|86|94|101|108|115|122|129|136|143|150|157|162|167|172)M"))),
      estimate = pop_unemployed_est)
  ) %>% 
  ungroup() %>%
  mutate(
    unemploy_rate_est = pop_unemployed_est / na_if(laborforce_est,0),
    unemploy_rate_moe = moe_prop(pop_unemployed_est, na_if(laborforce_est,0), pop_unemployed_moe, laborforce_moe)
  )

# just for this preview, remove all columns matching this pattern, so we can
# more easily see our new columns
bmore_census_unemployment %>% 
  select(-matches("B\\d{5}_\\d{3}."))
```
3. Calling the education table then manipulating that data 
```{r}
bmore_census_educ <- get_acs(
  geography = "tract", 
  state = "MD",
  county = c("510"),
  table = "B15003",
  survey = "acs5",
  output = "wide",
  geometry = FALSE)
bmore_census_educ
```
Creating variables: 
```{r}
bmore_census_education <- bmore_census_educ %>%
  mutate(
    pop_edu_denom_est = B15003_001E,
    pop_edu_denom_moe = B15003_001M,
  ) %>%
  rowwise() %>%
  mutate(
    pop_edu_nohs_num_est = sum(c_across(c(matches("B15003_0{0,2}(2|3|4|5|6|7|8|9|10|11|12|13|14|15|16)E")))),
    pop_edu_nohs_num_moe = moe_sum(
      moe = c_across(c(matches("B15003_0{0,2}(2|3|4|5|6|7|8|9|10|11|12|13|14|15|16)M"))),
      estimate = pop_edu_nohs_num_est
    ),
    pop_edu_somecoll_plus_est = sum(c_across(c(matches("B15003_0{0,2}(19|20|21|22|23|24|25)E")))),
    pop_edu_somecoll_plus_moe = moe_sum(
      moe = c_across(c(matches("B15003_0{0,2}(19|20|21|22|23|24|25)M"))),
      estimate = pop_edu_somecoll_plus_est
    )
  ) %>%
  ungroup() %>% 
  mutate(
    noHS_educ_pct = pop_edu_nohs_num_est / na_if (pop_edu_denom_est, 0),
    noHS_educ_pct_moe = pop_edu_nohs_num_moe / na_if (pop_edu_denom_moe, 0),
    somecollege_plus_pct = pop_edu_somecoll_plus_est / na_if (pop_edu_denom_est, 0),
    somecollege_plus_pct_moe = pop_edu_somecoll_plus_moe / na_if (pop_edu_denom_moe,0)
  )
  
bmore_census_education %>% 
  select(-matches("B\\d{5}_\\d{3}."))
```


4. Calling race/ethnicity table then manipulating that data 
```{r}
bmore_census_race <- get_acs(
  geography = "tract", 
  state = "MD",
  county = c("510"),
  table = "B02001",
  survey = "acs5",
  output = "wide",
  geometry = FALSE)
bmore_census_race
```
Creating the variables: 
```{r}
bmore_census_r<- get_acs(
  geography = "tract", 
  state = "MD",
  county = c("510"),
  variables = c(
    "race_denom" = "B02001_001",
    "black_num" = "B02009_001"),
  survey = "acs5",
  output = "wide",
  geometry = FALSE)

bmore_census_r
```
```{r}
bmore_census_race <- bmore_census_r %>% 
  mutate(
    pct_black_est = black_numE / na_if(race_denomE,0),
    pct_black_moe = moe_prop(black_numE, na_if(race_denomE,0), black_numM, race_denomM)
  )
```



